{"componentChunkName":"component---src-templates-blog-post-js","path":"/200419-Two-Ways-to-Vizualize-Realtime-Bus-Locations/","result":{"data":{"site":{"siteMetadata":{"title":"AvidDabbler Blog","author":"Walter Jenkins"}},"markdownRemark":{"id":"ab6e8920-ae16-50d4-8193-52c43d7b48d1","excerpt":"Introduction So over the years I have worked with GTFS feeds from agencies all around to run analysis and build frequency and trip based GIS visualizations. A…","html":"<h2>Introduction</h2>\n<p>So over the years I have worked with GTFS feeds from agencies all around to run analysis and build frequency and trip based GIS visualizations. A separate feed from <a href=\"https://developers.google.com/transit/gtfs\">GTFS</a> is called <a href=\"https://developers.google.com/transit/gtfs-rt\">GTFS-RT</a> that displays the Realtime locations. This feed as well as GTFS is a global standard and if you wanted to work with this kind of data in your own city check with your local transit authority to see if they are one of the Agencies that <a href=\"https://transitfeeds.com/\">Openly Publish</a> there information.</p>\n<p>This blog post started with a Twitter poll where I asked what people would be interested in me writing about and it was overwhelmingly in favor of Realtime bus locations. Granted the othere options were pretty much geared toward transit policy woks and people like pretty things, but I digress. Vizualizing GTFS-RT has been on my todo list for some time and I am glad that I got around to tackling the problem.</p>\n<h3>Data Two Ways</h3>\n<p>Starting this project it was geared toward the agency wanting to create a service that would process the information server side and host as a Hosted Service for use on an ArcGIS Enterprise system. However, I ended up failing to do so, but have been able to get it running on my local machine so I will show you how I did that. I do have some plans to get this running using a Lambda function or ec2 instance in the future, but haven’t played around with it too much.</p>\n<p>The other way that I was able to get it up and running is through the MapBox PB API. I started this article thinking that I was going to cover it, but to be quite honest you should go read his <a href=\"https://gavinr.com/protocol-buffers-protobuf-browser/\">post</a> it is so much better than anything that I could write so I am just going to cover what I ended up fulling putting together on my end using Python. </p>\n<h2>Building a Feature Service using Python</h2>\n<p>So I am going to be honest. I am not sure if I am using this term correctly. In ArcGIS Online/Enterprise world a GIS layer on their online platfor is called a Hosted Feature, but at the end of this you will just be left with a Python script that will output a json file that you can map out. </p>\n<h3>Getting your data</h3>\n<p>So like I said previously you will need a GTFS and GTFS-RT for this project which are generally available openly for most transit agencies. The GTFS is the static feed. This feed will have all of the static elements that will repeat over time, like Stop locations, route attributes, and trip alignments. I have separated each of these out into 2 different calls because the GTFS will at most change once a week where as the GTFS-RT is going to update around every 30 seconds. </p>\n<p><em>Rule of Thumb: Transit agencies generally change their GTFS on Monday</em></p>\n<p><strong>GTFS fetch</strong></p>\n<p>The first thing that you are going to want to do is fetch the Python file and extract the data. Making sure this is run at the top of the script so you do not run this in a loop and when it starts up the first thing it will do is make sure that there is a fresh GTFS to go with the realtime information that is getting pulled in. The purpose for this is the GTFS-RT does not have all of the relevant information that someone would want, but the GTFS is designed to link up to the GTFS-RT and it has all of the information that you would want. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">def getGTFS(gtfs_url):\n    gtfs = [ # list of gtfs files and their locations\n        os.path.join(dir, &#39;agency.txt&#39;),\n        os.path.join(dir, &#39;calendar.txt&#39;),\n        os.path.join(dir, &#39;calendar_dates.txt&#39;),\n        os.path.join(dir, &#39;routes.txt&#39;),\n        os.path.join(dir, &#39;shapes.txt&#39;),\n        os.path.join(dir, &#39;stop_times.txt&#39;),\n        os.path.join(dir, &#39;stops.txt&#39;),\n        os.path.join(dir, &#39;transfers.txt&#39;),\n        os.path.join(dir, &#39;trips.txt&#39;),\n    ]\n    for file in gtfs: # delete gtfs files before fetching\n        if os.path.exists(file):\n            os.remove(file)\n\n    print(&#39;FETCHING GTFS...&#39;)\n\n\n    zipresp = urlopen(gtfs_url) # Create a new file on the hard drive\n    tempzip = open(&quot;google_transit.zip&quot;, &quot;wb&quot;) # Write the contents of the downloaded file into the new file\n    tempzip.write(zipresp.read()) # Close the newly-created file\n    tempzip.close() # Re-open the newly-created file with ZipFile()\n\n    # Extract its contents into &lt;extraction_path&gt; *note that extractall will automatically create the path\n    zf = zipfile.ZipFile(&quot;google_transit.zip&quot;) \n    zf.extractall(dir) # close the ZipFile instance\n    zf.close()\n    os.remove(fr&quot;{dir}/google_transit.zip&quot;)\n\n    print(&#39;FETCH COMPLETE!&#39;)</code></pre></div>\n<p><strong>GTFS-RT fetch</strong></p>\n<p>There are 2 different files when it comes to the GTFS-RT that you will be interested in:</p>\n<ul>\n<li>Trips</li>\n<li>Vehicles</li>\n</ul>\n<p>The trips data issues out information about the realtime associated with each trip that is currently in service. You can link up the information in the static GTFS from the trips.txt file using the trip<em>id column (and then the routes and shapes and stop</em>times so on and so forth).</p>\n<p>The Vehicles data issue out information about the realtime locations of all of the buses.</p>\n<p>For more information you can reference the <a href=\"https://developers.google.com/transit/gtfs-realtime\">GTFS-Realtime Specification</a>.</p>\n<p>When you fetch out each of the datasets you are going to need to use the pip module in the <a href=\"https://pypi.org/project/google/\">google library</a> <code class=\"language-text\">google.transit.gtfs_realtime_pb2</code>. What I have done is put together a little function to the the Protocol Buffer infromation that the feed gives off and then parse it to a string and then to a dict. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    def parseDict(pbu):\n        # TAKES THE DATA FROM U (THE PB URL) AND TURNS IT INTO A DICTIONARY\n        feed = gtfs_realtime_pb2.FeedMessage()\n        response = requests.get(pbu)\n        feed.ParseFromString(response.content)\n        feed = MessageToDict(feed)\n        return feed</code></pre></div>\n<p>After you have a dictionary you can then inject data from the GTFS or where ever to the vehicles and trips information. I am not going to go over all of this, but you can take a look at my <a href=\"https://github.com/AvidDabbler/GTFSRT-parsing\">GTFSRT-parsing Repo</a> for mor in depth workthrough. From there what I did what convert the dict to a <a href=\"https://geojson.org/\">geojson format</a> by just creating a blank object labeled as a feature collection and within that feature collection there is a feature that has features. With each feature you need to create and inject data into the four different sections:</p>\n<ul>\n<li>type</li>\n<li>properties</li>\n<li>geometry</li>\n<li>data</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">        allVehicles = {}\n        allVehicles[&#39;type&#39;] = {}\n        allVehicles[&#39;type&#39;] = &#39;Feature Collection&#39;\n        allVehicles[&#39;features&#39;] = []\n\n feed = parseDict(pburl)\n        id = 0\n        for value in feed[&#39;entity&#39;]:\n            obj = {}\n\n            # LIST OF SECTIONS\n            list = [&quot;type&quot;, &quot;properties&quot;, &quot;geometry&quot;, &quot;data&quot;]\n            for i in list: # CREATE SECTIONS\n                obj[i] = {}\n            obj[&quot;type&quot;] = &quot;Feature&quot;\n\n            # START OF DATA SECTION\n            tripId = value[&quot;vehicle&quot;][&quot;trip&quot;][&quot;tripId&quot;]\n            uni = obj[&quot;data&quot;]\n            uni[&quot;vehicleId&quot;] = value[&quot;vehicle&quot;][&quot;vehicle&quot;][&quot;id&quot;]\n            uni[&quot;tripId&quot;] = tripId\n            uni[&quot;routeId&quot;] = value[&quot;vehicle&quot;][&quot;trip&quot;][&quot;routeId&quot;]\n            uni[&quot;coordinates&quot;] = [value[&quot;vehicle&quot;][&quot;position&quot;][&quot;longitude&quot;], value[&quot;vehicle&quot;][&quot;position&quot;][&quot;latitude&quot;]]\n\n            # START OF GEOMETRY SECTION\n            obj[&quot;geometry&quot;][&quot;type&quot;] = &quot;Point&quot;\n            obj[&quot;geometry&quot;][&quot;coordinates&quot;] = uni[&quot;coordinates&quot;]\n\n\n            # START OF PROPERTIES SECTION\n            obj[&quot;properties&quot;] = {}\n            obj[&quot;properties&quot;][&#39;id&#39;] = id\n\n            # ADD INDIVIDUAL VEHICLES TO LIST\n            id += 1\n            allVehicles[&#39;features&#39;].append(obj)\n        allVehicles = addVehicleInfo(allVehicles)\n        allVehicles = addVehiclePopups(allVehicles)\n        return allVehicles</code></pre></div>\n<p>Once you have this up and running you are going to save it locally and have it update at whatever rate you want the data to update with <code class=\"language-text\">time.sleep(x)</code> then host.</p>\n<h3>SOURCES!!!</h3>\n<p>Special thanks to Gavin Rehkemper @ <a href=\"https://www.esri.com\">ESRI</a>\nTwitter —> <a href=\"https://twitter.com/gavinrehkemper\">@GavinRehkemper</a>\nBlog —> <a href=\"https://gavinr.com/protocol-buffers-protobuf-browser/\">https://gavinr.com/protocol-buffers-protobuf-browser/</a></p>\n<p>OpenMobilityData.org —> <a href=\"https://openmobilitydata.org/\">https://openmobilitydata.org/</a></p>","frontmatter":{"title":"Vizualizing Realtime Bus Locations using GTFS-RT","date":"April 19, 2020","description":"A web developer's guide to vizualizing GTFS-RT with Python or JavaScript"}}},"pageContext":{"slug":"/200419-Two-Ways-to-Vizualize-Realtime-Bus-Locations/","previous":{"fields":{"slug":"/190915-UGH-I-Broke-My-Pi/"},"frontmatter":{"title":"Ugh!!! I Broke My Pi"}},"next":{"fields":{"slug":"/200511-Stop-Using-American-FactFinder/"},"frontmatter":{"title":"Stop Using American FactFinder"}}}}}